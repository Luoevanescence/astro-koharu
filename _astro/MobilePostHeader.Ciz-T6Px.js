import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{a as v}from"./design-tokens.Dn6fllXW.js";import{H as w,u as I,a as E,b as F,c as M}from"./HeadingList.HPVpYX4q.js";import{r as j}from"./index.D6whbu08.js";import{a as O}from"./useMediaQuery.Y0-LYbE-.js";import{s as P}from"./site-config.BAbVgF_m.js";import{u as C}from"./use-reduced-motion.BKjon5lW.js";import{A as S}from"./index.s74VRsaB.js";import{m as b}from"./proxy.C2vk4wBE.js";import{u as R,a as L,b as A,c as T,d as q,e as z,F as D,f as Y}from"./useFloatingUI.BQ67YeUn.js";import{c as _}from"./utils.BpMRZbEX.js";import{u as V}from"./use-scroll.CVDpqwY3.js";import{u as $}from"./use-spring.A72hWlzE.js";import"./_commonjsHelpers.CqkleIqs.js";import"./site.a4jwyKQn.js";import"./index.Bn74zGeF.js";import"./index.BFlOlsrl.js";import"./use-motion-value.-w1ZE3rh.js";function B(s){let t=null;const i=new Set;let l=null;const r=new Map,g=()=>{i.forEach(n=>{n()})},p=n=>{t?.id!==n?.id&&(t=n,g())},m=()=>{if(r.size===0)return;let n="",x=Number.POSITIVE_INFINITY,c=null;if(r.forEach(({top:o,element:d},u)=>{o<x&&(x=o,n=u,c=d)}),c&&n){const o=parseInt(c.tagName.substring(1),10);p({id:n,text:c.textContent?.trim()||"",level:o})}},a=()=>{l&&l.disconnect(),r.clear(),t=null;const n=document.querySelector("article");if(!n)return;const x=`-${s}px 0px -70% 0px`;l=new IntersectionObserver(o=>{for(const d of o){const u=d.target,h=u.id;h&&(d.isIntersecting?r.set(h,{top:d.boundingClientRect.top,element:u}):r.delete(h))}m()},{rootMargin:x,threshold:0});const c=n.querySelectorAll("h2:not(.link-preview-block h2), h3:not(.link-preview-block h3)");c.forEach(o=>{o.id&&l?.observe(o)}),c.length>0&&r.size===0&&requestAnimationFrame(()=>{const o=Array.from(c);for(let d=o.length-1;d>=0;d--){const u=o[d];if(u.getBoundingClientRect().top<s&&u.id){const y=parseInt(u.tagName.substring(1),10);p({id:u.id,text:u.textContent?.trim()||"",level:y});break}}})},f=()=>{r.clear(),t=null,requestAnimationFrame(()=>{a()})};return{subscribe:n=>(i.size===0&&(document.readyState!=="loading"&&a(),document.addEventListener("astro:page-load",f)),i.add(n),()=>{i.delete(n),i.size===0&&(l&&(l.disconnect(),l=null),document.removeEventListener("astro:page-load",f),r.clear())}),getSnapshot:()=>t,getServerSnapshot:()=>null}}function Q({offsetTop:s=80}={}){const t=j.useMemo(()=>B(s),[s]);return j.useSyncExternalStore(t.subscribe,t.getSnapshot,t.getServerSnapshot)}function U({heading:s,className:t}){const i=C();return e.jsx(S,{mode:"wait",children:s&&e.jsx(b.span,{className:`block truncate font-medium text-sm ${t||""}`,initial:i?{opacity:0}:{opacity:0,y:20,filter:"blur(4px)"},animate:i?{opacity:1}:{opacity:1,y:0,filter:"blur(0px)"},exit:i?{opacity:0}:{opacity:0,y:-12,filter:"blur(4px)"},transition:{default:{type:"spring",stiffness:400,damping:30},filter:{type:"tween",duration:.2,ease:"easeOut"}},children:s.text},s.id)})}function G({headings:s,activeId:t,expandedIds:i,onHeadingClick:l,trigger:r,open:g,onOpenChange:p,enableNumbering:m=!0}){const[a,f]=R({value:g,defaultValue:!1,onChange:p}),{refs:n,floatingStyles:x,context:c}=L({open:a,onOpenChange:f,placement:"bottom-start",offset:8,transform:!1}),o=A(c),d=T(c,{ancestorScroll:!0}),u=q(c),{getReferenceProps:h,getFloatingProps:y}=z([o,d,u]),H=N=>{l(N),f(!1)};return e.jsxs(e.Fragment,{children:[j.cloneElement(r,h({ref:n.setReference,...r.props})),e.jsx(S,{children:a&&e.jsx(D,{children:e.jsx(Y,{context:c,modal:!1,children:e.jsx(b.div,{ref:n.setFloating,style:x,className:"z-50 max-h-[60vh] w-72 overflow-auto rounded-2xl border border-border bg-background/80 p-3 backdrop-blur-md",initial:{opacity:0,scale:.85},animate:{opacity:1,scale:1,originY:0},exit:{opacity:0,scale:.85},transition:v.spring.popoverContent,...y(),children:e.jsx("nav",{className:_("toc-container",{"toc-no-numbering":!m}),"aria-label":"文章目录",children:e.jsx("div",{className:"space-y-1",children:e.jsx(w,{headings:s,depth:0,activeId:t,expandedIds:i,onHeadingClick:H})})})})})})})]})}function J({size:s=28,strokeWidth:t=2,className:i}){const l=C(),{scrollYProgress:r}=V(),g=$(r,{stiffness:100,damping:30,restDelta:.001}),p=l?r:g,m=(s-t)/2,a=s/2;return e.jsxs("svg",{width:s,height:s,className:i,"aria-label":"阅读进度",role:"progressbar",style:{transform:"rotate(-90deg)"},children:[e.jsx("circle",{cx:a,cy:a,r:m,fill:"transparent",stroke:"currentColor",strokeWidth:t,className:"opacity-20"}),e.jsx(b.circle,{cx:a,cy:a,r:m,fill:"transparent",stroke:"currentColor",strokeWidth:t,strokeLinecap:"round",className:"text-primary",style:{pathLength:p}})]})}const k=80;function ge({isPostPage:s,logoElement:t,logoText:i,logoSrc:l,enableNumbering:r=!0}){const g=C(),p=O("(max-width: 992px)"),m=Q({offsetTop:k}),a=I(),f=E({offsetTop:k+40}),{expandedIds:n,setExpandedIds:x}=F({headings:a,activeId:f,defaultExpanded:!1}),c=s&&p&&a.length>0&&m!==null,o=M({headings:a,setExpandedIds:x}),d=()=>e.jsx("a",{href:"/",className:"flex items-center gap-1",children:t==="svg"&&l?e.jsx("img",{src:l,alt:P?.alternate,className:"h-8",height:32}):e.jsx("span",{className:"logo-text",children:i})});return p?e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(S,{mode:"wait",children:c?e.jsx(b.div,{className:"flex items-center",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:g?{duration:0}:v.spring.gentle,children:e.jsx(G,{headings:a,activeId:f,expandedIds:n,onHeadingClick:o,enableNumbering:r,trigger:e.jsxs("button",{type:"button",className:"flex w-[calc(100vw-10.5rem)] items-center gap-2.5 rounded-full bg-foreground/10 py-1 pr-3 pl-1.5 backdrop-blur-sm transition-colors hover:bg-foreground/20","aria-label":"展开目录",children:[e.jsx("div",{className:"relative shrink-0",children:e.jsx(J,{size:32,strokeWidth:2.5})}),e.jsx("div",{className:"overflow-hidden",children:e.jsx(U,{heading:m})})]})})},"heading-mode"):e.jsx(b.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:g?{duration:0}:v.spring.gentle,children:e.jsx(d,{})},"logo-mode")})}):e.jsx(d,{})}export{ge as MobilePostHeader};
